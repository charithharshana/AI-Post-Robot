<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Resolution Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #fileInput {
            margin: 10px 0;
        }
        .image-info {
            margin: 10px 0;
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>AI Post Robot - Image Resolution Test</h1>
    <p>This test verifies that the extension uses original full-resolution images for AI processing instead of thumbnails.</p>

    <div class="test-section">
        <h2>Test Image Upload and Processing</h2>
        <input type="file" id="fileInput" accept="image/*">
        <button onclick="testImageProcessing()">Test Image Processing</button>
        <div id="testResults"></div>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="overallResults"></div>
    </div>

    <script>
        // Mock the AI Image Editor Module for testing
        class MockAIImageEditorModule {
            constructor() {
                this.testResults = [];
            }

            async convertToPermanentStorage(imageUrl, baseName = 'test-image') {
                console.log('üîÑ Testing convertToPermanentStorage with:', imageUrl.substring(0, 50) + '...');
                
                // Simulate the original function behavior
                const response = await fetch(imageUrl);
                const blob = await response.blob();
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const fileName = `${baseName}-${timestamp}.png`;
                const file = new File([blob], fileName, { type: 'image/png' });

                // Create optimized version if larger than 100KB (like the original code)
                let optimizedDataUrl = imageUrl;
                if (blob.size > 100000) {
                    try {
                        optimizedDataUrl = await this.createOptimizedDataUrl(imageUrl, 300, 300);
                        console.log('üì¶ Created optimized data URL for storage');
                    } catch (optimizeError) {
                        console.warn('‚ö†Ô∏è Failed to optimize image, using original:', optimizeError);
                    }
                }

                return {
                    dataUrl: optimizedDataUrl, // Optimized version for storage
                    originalDataUrl: imageUrl, // Original full-resolution
                    storageId: 'mock-storage-id',
                    file: file,
                    fileName: fileName,
                    fileType: 'image/png',
                    isVideo: false,
                    needsUpload: false
                };
            }

            async createOptimizedDataUrl(originalDataUrl, maxWidth = 300, maxHeight = 300, quality = 0.7) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            // Calculate new dimensions while maintaining aspect ratio
                            let { width, height } = img;
                            if (width > maxWidth || height > maxHeight) {
                                const ratio = Math.min(maxWidth / width, maxHeight / height);
                                width *= ratio;
                                height *= ratio;
                            }

                            canvas.width = width;
                            canvas.height = height;

                            // Draw the resized image
                            ctx.drawImage(img, 0, 0, width, height);

                            // Convert to data URL with compression
                            const optimizedDataUrl = canvas.toDataURL('image/jpeg', quality);
                            resolve(optimizedDataUrl);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    img.onerror = reject;
                    img.src = originalDataUrl;
                });
            }

            async imageUrlToBase64(imageUrl) {
                if (imageUrl.startsWith('data:')) {
                    const base64Data = imageUrl.split(',')[1];
                    return base64Data;
                }
                // For this test, we'll just return a mock base64
                return 'mock-base64-data';
            }

            // Test the fixed behavior
            async testAIProcessing(attachedFile) {
                console.log('üß™ Testing AI processing with attached file:', attachedFile.name);
                
                const permanentData = await this.convertToPermanentStorage(attachedFile.dataUrl, `attached-${attachedFile.name}`);
                
                // This is the FIXED code - should use originalDataUrl
                const imageData = await this.imageUrlToBase64(permanentData.originalDataUrl || permanentData.dataUrl);
                
                return {
                    usedOriginal: permanentData.originalDataUrl !== undefined,
                    originalSize: this.getDataUrlSize(permanentData.originalDataUrl),
                    optimizedSize: this.getDataUrlSize(permanentData.dataUrl),
                    usedForAI: permanentData.originalDataUrl || permanentData.dataUrl
                };
            }

            getDataUrlSize(dataUrl) {
                if (!dataUrl) return 0;
                // Approximate size calculation
                return Math.round(dataUrl.length * 0.75); // Base64 is ~33% larger than binary
            }
        }

        const mockModule = new MockAIImageEditorModule();

        async function testImageProcessing() {
            const fileInput = document.getElementById('fileInput');
            const resultsDiv = document.getElementById('testResults');
            
            if (!fileInput.files[0]) {
                resultsDiv.innerHTML = '<div class="error">Please select an image file first.</div>';
                return;
            }

            const file = fileInput.files[0];
            resultsDiv.innerHTML = '<div class="info">Testing image processing...</div>';

            try {
                // Create data URL from file
                const dataUrl = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                // Test the processing
                const attachedFile = {
                    name: file.name,
                    dataUrl: dataUrl,
                    file: file
                };

                const result = await mockModule.testAIProcessing(attachedFile);
                
                // Display results
                let html = '<div class="image-info">';
                html += `<strong>Original File:</strong> ${file.name}<br>`;
                html += `<strong>File Size:</strong> ${(file.size / 1024).toFixed(2)} KB<br>`;
                html += `<strong>Original Data URL Size:</strong> ${(result.originalSize / 1024).toFixed(2)} KB<br>`;
                html += `<strong>Optimized Data URL Size:</strong> ${(result.optimizedSize / 1024).toFixed(2)} KB<br>`;
                html += '</div>';

                if (result.usedOriginal && result.originalSize > result.optimizedSize) {
                    html += '<div class="success">‚úÖ SUCCESS: AI processing uses original full-resolution image!</div>';
                    html += `<div class="info">The fix is working correctly. AI operations will receive the ${(result.originalSize / 1024).toFixed(2)} KB original image instead of the ${(result.optimizedSize / 1024).toFixed(2)} KB thumbnail.</div>`;
                } else if (!result.usedOriginal) {
                    html += '<div class="error">‚ùå ISSUE: AI processing is not using original image!</div>';
                } else {
                    html += '<div class="info">‚ÑπÔ∏è Image is small enough that no optimization was applied.</div>';
                }

                resultsDiv.innerHTML = html;
                updateOverallResults(true);

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Test failed: ${error.message}</div>`;
                updateOverallResults(false);
            }
        }

        function updateOverallResults(testPassed) {
            const overallDiv = document.getElementById('overallResults');
            if (testPassed) {
                overallDiv.innerHTML = '<div class="success"><strong>‚úÖ Image Resolution Fix Verified</strong><br>The extension now correctly uses original full-resolution images for AI processing instead of thumbnails.</div>';
            } else {
                overallDiv.innerHTML = '<div class="error"><strong>‚ùå Test Failed</strong><br>There may still be issues with image resolution handling.</div>';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ Image Resolution Test initialized');
        });
    </script>
</body>
</html>
